!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Pjax=e()}(this,(function(){"use strict";function forEachEls(t,e,o){return t instanceof HTMLCollection||t instanceof NodeList||t instanceof Array?Array.prototype.forEach.call(t,e,o):e.call(o,t)}function evalScript(t){const e=t.text||t.textContent||t.innerHTML||"",o=t.src||"",s=t.parentNode||document.querySelector("head")||document.documentElement,n=document.createElement("script");return!e.match("document.write")&&(n.type="text/javascript",n.id=t.id,""!==o&&(n.src=o,n.async=!1),""!==e&&n.appendChild(document.createTextNode(e)),s.appendChild(n),(s instanceof HTMLHeadElement||s instanceof HTMLBodyElement)&&s.contains(n)&&s.removeChild(n),!0)}function outerHTML(t,e){t.outerHTML=e.outerHTML,this.onSwitch()}function switchElementsAlt(t,e){if(t.innerHTML=e.innerHTML,e.hasAttributes()){let o=e.attributes;for(let e=0;e<o.length;e++)t.attributes.setNamedItem(o[e].cloneNode())}this.onSwitch()}function foreachSelectors(t,e,o,s=document){t.forEach((t=>{forEachEls(s.querySelectorAll(t),e,o)}))}function switchesSelectors(t,e,o,s,n,i){const r=[];o.forEach((function(o){const l=s.querySelectorAll(o),c=n.querySelectorAll(o);if(l.length!==c.length)throw`DOM doesn’t look the same on new loaded page: ’${o}’ - new ${l.length}, old ${c.length}`;forEachEls(l,(function(s,n){const l=c[n],a=t[o]?t[o].bind(this,l,s,i,e[o]):outerHTML.bind(this,l,s,i);r.push(a)}),this)}),this),this.state.numPendingSwitches=r.length,r.forEach((t=>{t()}))}var t=function(){let t=0;return function(){const e=`pjax${(new Date).getTime()}_${t}`;return t++,e}}();function eventForEach(t,e){(t="string"==typeof t?t.split(" "):t).forEach(e)}function on(t,e,o,s){eventForEach(e,(e=>{forEachEls(t,(t=>{t.addEventListener(e,o,s)}))}))}function trigger(t,e,o={}){eventForEach(e,(e=>{const s=new CustomEvent(e,{bubbles:!0,cancelable:!0,...o});forEachEls(t,(t=>{t.dispatchEvent(s)}))}))}const e="data-pjax-state",linkAction=function(t,o){if(o.defaultPrevented||!1===o.returnValue)return;const s={...this.options},n=function checkIfShouldAbort(t,e){if(e.which>1||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)return"modifier";if(t.protocol!==window.location.protocol||t.host!==window.location.host)return"external";if(t.hash&&t.href.replace(t.hash,"")===window.location.href.replace(location.hash,""))return"anchor";if(t.href===window.location.href.split("#")[0]+"#")return"anchor-empty"}(t,o);if(n)t.setAttribute(e,n);else{if(o.preventDefault(),this.options.currentUrlFullReload&&t.href===window.location.href.split("#")[0])return t.setAttribute(e,"reload"),void this.reload();t.setAttribute(e,"load"),s.triggerElement=t,this.loadUrl(t.href,s)}};function parseElement(t){if("a"!==t.tagName.toLowerCase())throw"theme-shokax-pjax can only be applied on <a>";t.hasAttribute("data-pjax-state")||this.attachLink(t)}class Pjax{constructor(e){this.state={numPendingSwitches:0,href:null,options:null},this.options=function parseOptions(t={}){return t.elements=t.elements||"a[href], form[action]",t.selectors=t.selectors||["title",".js-Pjax"],t.switches=t.switches||{},t.switchesOptions=t.switchesOptions||{},t.history=void 0===t.history||t.history,t.scrollTo=void 0===t.scrollTo?0:t.scrollTo,t.scrollRestoration=void 0===t.scrollRestoration||t.scrollRestoration,t.cacheBust=void 0===t.cacheBust||t.cacheBust,t.timeout=t.timeout||0,t.currentUrlFullReload=void 0!==t.currentUrlFullReload&&t.currentUrlFullReload,t.switches.head||(t.switches.head=switchElementsAlt),t.switches.body||(t.switches.body=switchElementsAlt),t}(e),this.options.scrollRestoration&&"scrollRestoration"in history&&(history.scrollRestoration="manual"),this.maxUid=this.lastUid=t(),this.parseDOM(document),on(window,"popstate",function(t){if(t.state){const e={...this.options};e.url=t.state.url,e.title=t.state.title,e.history=!1,e.scrollPos=t.state.scrollPos,t.state.uid<this.lastUid?e.backward=!0:e.forward=!0,this.lastUid=t.state.uid,this.loadUrl(t.state.url,e)}}.bind(this))}getElements(t){return t.querySelectorAll(this.options.elements)}parseDOM(t){forEachEls(this.getElements(t),parseElement,this)}refresh(t){this.parseDOM(t||document)}reload(){window.location.reload()}forEachSelectors(t,e,o){return foreachSelectors.bind(this)(this.options.selectors,t,e,o)}switchSelectors(t,e,o,s){return switchesSelectors.bind(this)(this.options.switches,this.options.switchesOptions,t,e,o,s)}latestChance(t){window.location=t}onSwitch(){trigger(window,"resize scroll"),this.state.numPendingSwitches--,0===this.state.numPendingSwitches&&this.afterAllSwitches()}loadContent(t,e){if("string"!=typeof t)return void trigger(document,"pjax:complete pjax:error",e);const o=document.implementation.createHTMLDocument("pjax"),s=/\s?[a-z:]+(?:=['"][^'">]+['"])*/gi;let n=t.match(/<html[^>]+>/gi);if(n&&n.length&&(n=n[0].match(s),n.length&&(n.shift(),n.forEach((function(t){const e=t.trim().split("=");1===e.length?o.documentElement.setAttribute(e[0],"true"):o.documentElement.setAttribute(e[0],e[1].slice(1,-1))})))),o.documentElement.innerHTML=t,document.activeElement&&function contains(t,e,o){for(let s=0;s<e.length;s++){const n=t.querySelectorAll(e[s]);for(let t=0;t<n.length;t++)if(n[t].contains(o))return!0}return!1}(document,this.options.selectors,document.activeElement))try{document.activeElement.blur()}catch(t){}this.switchSelectors(this.options.selectors,o,document,e)}loadUrl(t,e){e="object"==typeof e?Object.assign({},this.options,e):{...this.options},this.abortRequest(this.request),trigger(document,"pjax:send",e),this.request=this.doRequest(t,e,this.handleResponse.bind(this))}afterAllSwitches(){this.options.selectors.forEach((t=>{forEachEls(document.querySelectorAll(t),(t=>{!function executeScripts(t){"script"===t.tagName.toLowerCase()&&evalScript(t),forEachEls(t.querySelectorAll("script"),(function(t){t.type&&"text/javascript"!==t.type.toLowerCase()||(t.parentNode&&t.parentNode.removeChild(t),evalScript(t))}))}(t)}))}));const e=this.state;if(e.options.history&&(window.history.state||(this.lastUid=this.maxUid=t(),window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid,scrollPos:[0,0]},document.title)),this.lastUid=this.maxUid=t(),window.history.pushState({url:e.href,title:e.options.title,uid:this.maxUid,scrollPos:[0,0]},e.options.title,e.href)),this.forEachSelectors((function(t){this.parseDOM(t)}),this),trigger(document,"pjax:complete pjax:success",e.options),e.options.history){const t=document.createElement("a");if(t.href=this.state.href,t.hash){let e=t.hash.slice(1);e=decodeURIComponent(e);let o=0,s=document.getElementById(e)||document.getElementsByName(e)[0];if(s&&s.offsetParent)do{o+=s.offsetTop,s=s.offsetParent}while(s);window.scrollTo(0,o)}else!1!==e.options.scrollTo&&(e.options.scrollTo.length>1?window.scrollTo(e.options.scrollTo[0],e.options.scrollTo[1]):window.scrollTo(0,e.options.scrollTo))}else e.options.scrollRestoration&&e.options.scrollPos&&window.scrollTo(e.options.scrollPos[0],e.options.scrollPos[1]);this.state={numPendingSwitches:0,href:null,options:null}}abortRequest(t){t&&t.readyState<4&&(t.onreadystatechange=function(){},t.abort())}}return Pjax.prototype.attachLink=function attachLink(t){const o=this;t.setAttribute(e,""),on(t,"click",(function(e){linkAction.call(o,t,e)})),on(t,"keyup",function(e){13===e.keyCode&&linkAction.call(o,t,e)}.bind(this))},Pjax.prototype.doRequest=function sendRequest(t,e={},o){const s=e.requestOptions||{},n=(s.requestMethod||"GET").toUpperCase(),i=s.requestParams||null;let r=null;const l=new XMLHttpRequest,c=e.timeout;if(l.onreadystatechange=function(){4===l.readyState&&(200===l.status?o(l.responseText,l,t,e):0!==l.status&&o(null,l,t,e))},l.onerror=function(s){console.error(s),o(null,l,t,e)},l.ontimeout=function(){o(null,l,t,e)},i&&i.length){let e=i.map((function(t){return t.name+"="+t.value})).join("&");switch(n){case"GET":t=t.split("?")[0],t+="?"+e;break;case"POST":r=e}}return e.cacheBust&&(t=function updateQueryString(t,e,o){const s=new RegExp("([?&])"+e+"=.*?(&|$)","i"),n=-1!==t.indexOf("?")?"&":"?";return t.match(s)?t.replace(s,"$1"+e+"="+o+"$2"):t+n+e+"="+o}(t,"t",Date.now())),l.open(n,t,!0),l.timeout=c,l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.setRequestHeader("X-PJAX","true"),l.setRequestHeader("X-PJAX-Selectors",JSON.stringify(e.selectors)),l.send(r),l},Pjax.prototype.handleResponse=function handleResponse(e,o,s,n){if((n={...n||this.options}).request=o,!1===e)return void trigger(document,"pjax:complete pjax:error",n);const i=window.history.state||{};window.history.replaceState({url:i.url||window.location.href,title:i.title||document.title,uid:i.uid||t(),scrollPos:[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop]},document.title,window.location.href);const r=s;o.responseURL?s!==o.responseURL&&(s=o.responseURL):o.getResponseHeader("X-PJAX-URL")?s=o.getResponseHeader("X-PJAX-URL"):o.getResponseHeader("X-XHR-Redirected-To")&&(s=o.getResponseHeader("X-XHR-Redirected-To"));const l=document.createElement("a");l.href=r;const c=l.hash;l.href=s,c&&!l.hash&&(l.hash=c,s=l.href),this.state.href=s,this.state.options=n;try{this.loadContent(e,n)}catch(t){return trigger(document,"pjax:error",n),console.error("Pjax switch fail: ",t),this.latestChance(s)}},Pjax.switches={innerHTML:function innerHTML(t,e){t.innerHTML=e.innerHTML,""===e.className?t.removeAttribute("class"):t.className=e.className,this.onSwitch()},outerHTML:outerHTML,switchElementsAlt:switchElementsAlt},Pjax}));
